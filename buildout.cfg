[buildout]
extends =
    https://zopefoundation.github.io/Zope/releases/6.0b2/versions-prod.cfg
    versions.cfg

parts =
    instance
    instance1
    instance2
    instance3
    instance4
    supervisor
    omelette
    zopepy
    import
    extensions
    autostart
    restart-celery
    restart-instances
    restart-soffice
    tmpcronjob
    pack-semanal
    chown

extensions = 
    mr.developer

package-name = openlegis.sagl

effective-user = zope

root-directory = ${buildout:directory}

# MySQL configuration
mysql-host = localhost
mysql-user = root
mysql-pass = openlegis
mysql-db = openlegis

sources-dir = src

develop =
    src/openlegis.sagl

auto-checkout = 
    openlegis.sagl
    Products.CMFDefault
    trml2pdf

eggs = 
    appy
    asn1crypto
    decorator
    five.grok
    html2rml
    html2text
    lxml
    mechanize
    ndg-httpsclient
    openlegis.sagl
    Pillow
    Products.CMFCore
    Products.CMFDefault
    Products.CMFUid
    Products.DCWorkflow
    Products.ExternalEditor
    Products.ExternalMethod    
    Products.MailHost
    Products.PluggableAuthService
    Products.PortalTransforms
    Products.Sessions
    Products.SiteErrorLog
    Products.TemporaryFolder
    Products.ZMySQLDA
    Products.ZODBMountPoint
    pyasn1
    pypdf
    python-barcode
    python-dateutil
    qrcode
    reportlab
    requests
    sgmllib3k
    simplejson
    six
    tempstorage
    trml2pdf
    Werkzeug
    z3c.autoinclude
    zLOG
    zope.app.container
    zope.file
    ZopeUndo
    z3c.saconfig
    zope.sqlalchemy
    sqlalchemy
    alembic
    mysqlclient
    pymysql
    celery[redis]
    aiofiles
    openpyxl
    pikepdf
    RelStorage[postgresql]
    psycopg2
    pymupdf
    websockets 
    psutil 
    pytesseract 
    ocrmypdf

zcml = ${buildout:package-name}

[sources]
openlegis.sagl = git https://github.com/openlegis-br/openlegis.sagl.git
# openlegis.recipe.sagl removido - não é mais necessário, a aplicação é criada automaticamente na inicialização do Zope
Products.CMFDefault = fs Products.CMFDefault
trml2pdf = fs trml2pdf

[instance]
recipe = plone.recipe.zope2instance
http-address = 8080
user = admin:openlegis
rel-storage =
    type postgresql
    dbname zodb
    user zodbuser
    host localhost
    password openlegis
    keep-history true
    pack-gc false
    cache-local-mb 2048
    commit-lock-timeout 30
    poll-interval 5
zope-conf-additional =  
    <zodb_db sapl_documentos>
      mount-point /sagl/sapl_documentos
      container-class OFS.Folder.Folder
      <relstorage>
        keep-history false
        <postgresql>
          dsn dbname=sapl_documentos user=zodbuser password=openlegis host=localhost port=5432
        </postgresql>
      </relstorage>
    </zodb_db>
    # Proteção DoS
    <dos_protection>
      form-memory-limit 4MB
    </dos_protection>
environment-vars =
    PYTHON_EGG_CACHE ${buildout:directory}/var/.python-eggs
    TEMP ${buildout:directory}/var/tmp
    TMP ${buildout:directory}/var/tmp
    INSTALL_HOME ${buildout:directory}
    PTS_LANGUAGES en, es, pt-br
    zope_i18n_allowed_languages en, es, pt-br
    zope_i18n_compile_mo_files true
    TZ America/Sao_Paulo
    RELSTORAGE_POLL_INTERVAL 5
    MYSQL_HOST ${buildout:mysql-host}
    MYSQL_USER ${buildout:mysql-user}
    MYSQL_PASS ${buildout:mysql-pass}
    MYSQL_DB ${buildout:mysql-db}
zcml-additional =
  <configure xmlns="http://namespaces.zope.org/db">
    <include package="z3c.saconfig" file="meta.zcml" />
    <engine name="meu_db" url="mysql+pymysql://${buildout:mysql-user}:${buildout:mysql-pass}@${buildout:mysql-host}/${buildout:mysql-db}?charset=utf8mb4" />
    <session name="minha_sessao" engine="meu_db" twophase="True" />
  </configure>
eggs =
    ${buildout:eggs}
zcml =
    ${buildout:zcml}

[instance1]
<= instance
http-address = 8081
access-log-args  = (r"${buildout:directory}/var/log/instance1-access.log", "a")
event-log-args = (r"${buildout:directory}/var/log/instance1.log", )

[instance2]
<= instance
http-address = 8082
access-log-args  = (r"${buildout:directory}/var/log/instance2-access.log", "a")
event-log-args = (r"${buildout:directory}/var/log/instance2.log", )

[instance3]
<= instance
http-address = 8083
access-log-args  = (r"${buildout:directory}/var/log/instance3-access.log", "a")
event-log-args = (r"${buildout:directory}/var/log/instance3.log", )

[instance4]
<= instance
http-address = 8084
access-log-args  = (r"${buildout:directory}/var/log/instance4-access.log", "a")
event-log-args = (r"${buildout:directory}/var/log/instance4.log", )

[supervisor]
recipe = collective.recipe.supervisor
plugins = superlance
port = 9001
user = openlegis
password = openlegis
serverurl = http://127.0.0.1:9001
programs =
    1 celery     (autorestart=true directory=${buildout:directory}/src/openlegis.sagl startsecs=10 stopwaitsecs=10) ${buildout:directory}/bin/celery [-A tasks worker -Q celery,prefeitura --loglevel=info -n celery@sagl6-worker]
    2 soffice    (autorestart=true) /usr/lib/libreoffice/program/soffice [--headless --nologo --nodefault --nofirststartwizard "--accept=socket,host=0.0.0.0,port=2002;urp;"] true 
    3 instance   (autostart=true startsecs=3)   ${buildout:directory}/bin/instance  [console]  true  ${buildout:effective-user}
    4 instance1  (autostart=true startsecs=5)   ${buildout:directory}/bin/instance1 [console]  true  ${buildout:effective-user}
    5 instance2  (autostart=true startsecs=5)   ${buildout:directory}/bin/instance2 [console]  true  ${buildout:effective-user}
    6 instance3  (autostart=true startsecs=5)   ${buildout:directory}/bin/instance3 [console]  true  ${buildout:effective-user}
    7 instance4  (autostart=true startsecs=5)   ${buildout:directory}/bin/instance4 [console]  true  ${buildout:effective-user}
groups =
    1 services soffice,celery
    2 instances instance,instance1,instance2,instance3,instance4

logfile = ${buildout:directory}/var/log/supervisord.log
loglevel = info
pidfile = ${buildout:directory}/var/supervisord.pid
nodaemon = false

[extensions]
recipe = plone.recipe.command
command = cp -r ${buildout:directory}/src/openlegis.sagl/openlegis/sagl/Extensions ${buildout:directory}/parts/instance/

[omelette]
recipe = collective.recipe.omelette
eggs = ${instance:eggs}

[zopepy]
recipe = zc.recipe.egg
interpreter = zopepy
eggs =
    Zope[wsgi]

[import]
recipe = plone.recipe.command
command = cp ${buildout:directory}/src/openlegis.sagl/import/*.zexp ${buildout:directory}/var/instance/import/

[chown]
recipe = plone.recipe.command
command = chown -R ${buildout:effective-user}:${buildout:effective-user} ${buildout:directory}

[autostart]
recipe = z3c.recipe.usercrontab
times = @reboot
command = ${buildout:directory}/bin/supervisord

[restart-celery]
recipe = z3c.recipe.usercrontab
times = 0 */6 * * *
command = ${buildout:directory}/bin/supervisorctl restart services:celery

[restart-instances]
recipe = z3c.recipe.usercrontab
times = 0 1 * * *
command = ${buildout:directory}/bin/supervisorctl restart instances:

[restart-soffice]
recipe = z3c.recipe.usercrontab
times = 0 */4 * * *
command =  ${buildout:directory}/bin/supervisorctl restart services:soffice

[tmpcronjob]
recipe = z3c.recipe.usercrontab
times = 0 */8 * * *
command = rm -rf ${buildout:directory}/var/tmp/processo_*

[pack-semanal]
recipe = z3c.recipe.usercrontab
times = 0 3 * * 0
command = command = ${buildout:directory}/bin/zodbpack --prepack ${buildout:directory}/zodbpack.conf && ${buildout:directory}/bin/zodbpack --use-prepack-state ${buildout:directory}/zodbpack.conf
